
from platform import node

import canopen
import can
import pyttsx3
import time
def sayText(words):
    engine = pyttsx3.init()
    engine.setProperty('rate',200)
    engine.setProperty('volume',1.0)
    engine.setProperty('voice','com.apple.speech.synthesis.voice.tingting')
    engine.say(words)
    engine.runAndWait()
    engine.stop()

def findDevice():
    isFindDevice = False
    network = canopen.Network()
    network.connect(bustype='slcan', channel='/dev/cu.usbmodem141101', bitrate=250000)
    node2 = network.add_node(2,'/Users/mac/tmp/HW_PY/ASDA-A3_v04.eds')
    # node2.nmt.send_command(0x01)
    messages = node2.sdo[0x1000]
    print(" %X" % messages.raw)

    # This will attempt to read an SDO from nodes 1 - 127
    network.scanner.search()
    # We may need to wait a short while here to allow all nodes to respond
   
    time.sleep(0.05)
    for node_id in network.scanner.nodes:
        print("Found node %d!" % node_id)
        sayText(f"节点ID为{hex(node_id)}")
        isFindDevice = True
    network.disconnect()
    return isFindDevice

def searchBaud():
    baudList = {100000,500000,250000,1000000,250000,50000,20000,125000}
    for baud in baudList:
        isFindDevice = findDevice(baud)
        if(isFindDevice == True):
            if(baud == 10000):
                print("baud num is 1")
                sayText(f"波特率ID为1")
                receive_all(baud)
            elif(baud == 20000):
                print("baud num is 2")
                sayText(f"波特率ID为2")
                receive_all(baud)
            elif(baud == 50000):
                print("baud num is 3")
                sayText(f"波特率ID为3")
                receive_all(baud)
            elif(baud == 100000):
                print("baud num is 4")
                sayText(f"波特率ID为4")
                receive_all(baud)
            elif(baud == 125000):
                print("baud num is 5")
                sayText(f"波特率ID为5")
                receive_all(baud)
            elif(baud == 250000):
                print("baud num is 6")
                sayText(f"波特率ID为6")
                receive_all(baud)
            elif(baud == 500000):
                print("baud num is 7")
                sayText(f"波特率ID为7")
                receive_all(baud)
            elif(baud == 1000000):
                print("baud num is 8 or 0 other number ")
                sayText(f"波特率ID为8或者0或者其他")
                receive_all(baud)

def receive_all(baud):
    """Receives all messages and prints them to the console until Ctrl+C is pressed."""
    with can.interface.Bus(
        bustype='slcan', channel='/dev/cu.usbmodem141101', bitrate=baud
    ) as bus:
        
        print("receiving date now ...... ")
        try:
            while True:
                msg = bus.recv(1)
                if msg is not None:
                    print(msg)

        except KeyboardInterrupt:
            pass  # exit normally  
    

if __name__ == "__main__":
    findDevice()